# chatgpt.sh
#!/bin/bash

keyfile="$HOME/.chatgpt-key"

if [ ! -f "$keyfile" ]; then
    echo "Error: File '$keyfile' does not exist."
    exit 1
fi

API_KEY="$(cat $keyfile)"

if [ $# -eq 0 ]; then
    echo "Error: No arguments provided."
    echo "Usage: ,gpt <arg1> [arg2 ...]"
    exit 1
fi

PROMPT="$*"
stdin=''

if [ ! -t 0 ]; then
    stdin="$(cat)"  # Read all stdin into the variable
fi

# engine='gpt-3.5-turbo'
engine='gpt-4o'

history_file="$HOME/.gpt-history"
last_gpt_answer_file="$HOME/.gpt-last-conv"

input=$(jq -Rn --arg input "$*
$stdin" '$input')

echo "$input" >> $history_file
echo "" >> $history_file

echo "$input" > $last_gpt_answer_file
echo "" >> $last_gpt_answer_file

data=$(jq -Rn --arg input "$*
$stdin" '{
    "model": "'"$engine"'",
    "messages": [{"role": "user", "content": '"$input"'}]
  }')

output=$(curl -s https://api.openai.com/v1/chat/completions \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d "$data")

resp=$(echo "$output" | jq -r '.choices[0].message.content')

if [ -z "$resp" ]; then
    echo $resp
    exit 1
fi

echo "$resp" | tee -a $history_file | tee -a $last_gpt_answer_file

echo "" >> $history_file
echo "" >> $history_file


